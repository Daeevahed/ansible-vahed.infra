---
- name: Create user {{ user.name }}
  user:
    name: "{{ user.name }}"
    shell: /bin/bash
    password: "{{ user_passwords[user.name] | default(omit) }}"
    state: present

- name: Add SSH key for {{ user.name }}
  authorized_key:
    user: "{{ user.name }}"
    key: "{{ user.ssh_key }}"

- name: Ensure {{ user.name }} is sudoer
  user:
    name: "{{ user.name }}"
    groups: sudo
    append: yes
  when: user.sudo | default(false)


- name: Ensure {{ user.name }} is NOT sudoer
  user:
    name: "{{ user.name }}"
    groups: sudo
    state: present
    append: no
  when: not (user.sudo | default(false))

- name: Remove {{ user.name }} from sudo group
  command: gpasswd -d {{ user.name }} sudo
  become: true
  when: not (user.sudo | default(false))